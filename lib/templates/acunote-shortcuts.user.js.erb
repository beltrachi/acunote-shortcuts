/*
 *  Acunote Shortcuts.
 *
 *  Acunote Shortcuts is a greasemonkey script based on
 *  Javascript Keyboard Shortcuts library extracted from Acunote
 *  http://www.acunote.com/open-source/javascript-keyboard-shortcuts
 *
 *  Adds keyboard navigation for:
 *  Reddit           http://reddit.com
 *  Digg             http://digg.com
 *  Hacker News      http://news.ycombinator.com
 *  Redmine          http://www.redmine.org
 *
 *  Shortcuts Library Copyright (c) 2007-2011 Pluron, Inc.
 *  Reddit, Digg and HN Scripts Copyright (c) 2008-2011 Pluron, Inc.
 *  Other scripts are copyright of their respective authors.
 *
 *  Permission is hereby granted, free of charge, to any person obtaining
 *  a copy of this software and associated documentation files (the
 *  "Software"), to deal in the Software without restriction, including
 *  without limitation the rights to use, copy, modify, merge, publish,
 *  distribute, sublicense, and/or sell copies of the Software, and to
 *  permit persons to whom the Software is furnished to do so, subject to
 *  the following conditions:
 *
 *  The above copyright notice and this permission notice shall be
 *  included in all copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 *  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 *  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 *  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 *  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 *  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

// --------------------------------------------------------------------
//
// ==UserScript==
// @name          Acunote Shortcuts
// @description   Adds cursor and keyboard shortcuts for news.ycombinator.com, reddit.com, digg.com and redmine.org
// @include       http://news.ycombinator.org*
// @include       http://news.ycombinator.com*
// @include       http://reddit.com*
// @include       http://www.reddit.com*
// @include       http://digg.com*
// @include       http://www.digg.com*
// @include       http://example.com*
// @include       http://www.redmine.org*
// ==/UserScript==


var w = null;
//It is not necessary to use unsafeWindow for non-Firefox browsers
//Opera & WebKit/Safari provide full access to window object;
if (typeof unsafeWindow !== 'undefined') {
    w = unsafeWindow;
} else {
    w = window;
}

/*
 *  ===========================================================
 *  Acunote Shortcuts: The Library
 *  Copyright (c) 2007-2008 Pluron, Inc.
 *  ===========================================================
 */
function ShortcutsSource() {
<%= indent acunote_shortcuts %>
}

<% sites.each do |site| %>
<%= site[:code] %>
<% end %>

// TODO: move the SupportedSites to a var or ShortcutsSource attribute and each
// service has to register there like ShortcutsSource.registerSite(name,code)

/*
 *  ===========================================================
 *  Shortcuts Library: Supported Sites
 *  This greasemonkey script matches site URL against the
 *  property name and gets the source of the function
 *  specified as property value.
 *  ===========================================================
 */
var SupportedSites = {
    'ycombinator':      HnSource,
    'reddit':           RedditSource,
    'digg':             DiggSource,
    'redmine.org':      RedmineSource,
    'example.com':      DummySource
}

// TODO: move this code to redmine file

//Allow any domain hosting a redmine instance to use it
// You need to allow this userscript on the domain. 
// In firefox you configure the script in the user config.
// Dirty hack search for the description metatag.
try{
    var item, list = document.getElementsByTagName("meta");
    for(var i = 0;i < list.length; i++){
        item = list[i];
        if( item.getAttribute("name") == "description" && 
                item.getAttribute("content") == "Redmine"){
            SupportedSites[location.hostname] = RedmineSource;
            break;
        }
    }
}catch(e){
    if(console) console.error(e);
}

/*
 *  ===========================================================
 *  Shortcuts Library: Loader
 *  Copyright (c) 2008 Pluron, Inc.
 *  ===========================================================
 */
var addScript = function(ShortcutsSource) {
    var getSource = function (func) {
        var js = func.toString(),
            i = js.indexOf('{');
        js = js.substr(i + 1, js.length - i - 2);
        return js;
    }
    var script = document.createElement('script'),
        source = getSource(ShortcutsSource);
    
    for (site in SupportedSites) {
        if (typeof(site) != 'string')
            continue;
        if (location.href.match(site)) {
            source += getSource(SupportedSites[site]) + '\n window.Cursor.init();';
            break;
        }
    }
    
    var text = document.createTextNode(source);
    script.appendChild(text);
    script.setAttribute('id','acunoteKeyboardShortcuts');
    if (!document.getElementById('acunoteKeyboardShortcuts')) {
        document.body.appendChild(script);
    }
}
addScript(ShortcutsSource);
